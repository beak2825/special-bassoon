<!DOCTYPE html>
<html lang="en-us">

<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Night City Racing</title>
    <style>
        html,
        body {
            background-image: url("Build/Build.jpg");
            background-position: center;
            /* Center the image */
            background-repeat: no-repeat;
            /* Do not repeat the image */
            background-size: cover;
            /* Resize the background image to cover the entire container */
            width: 100%;
            height: 100%;
            overflow: visible;
            padding: 0;
            margin: 0;
        }

        div#gameContainer {
            background: transparent !important;
            position: absolute;
        }

        div#gameContainer canvas {
            position: absolute;
        }

        div#gameContainer canvas[data-pixel-art="true"] {
            position: absolute;
            image-rendering: optimizeSpeed;
            image-rendering: -webkit-crisp-edges;
            image-rendering: -moz-crisp-edges;
            image-rendering: -o-crisp-edges;
            image-rendering: crisp-edges;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: optimize-contrast;
            image-rendering: pixelated;
            -ms-interpolation-mode: nearest-neighbor;
        }

        .loadingOut {
            width: 250px;
            position: fixed;
            left: 50%;
            top: calc(50% - 8px);
            transform: translate(-50%);
            border: 2px solid white;
            height: 14px;
        }

        .centered {
            position: fixed;
            top: 50%;
            left: 50%;
            margin-top: -150px;
            margin-left: -250px;
            width: 500px;
        }
    </style>
</head>

<body>
    <div id="gameContainer">
        <img src="https://cdn.jsdelivr.net/gh/beak2825/special-bassoon@main/night-city-racing/TemplateData/logo.png" class="centered">
        <div class="loadingOut"> </div>
        <canvas id="unity-canvas" data-pixel-art=""></canvas>
        <script src="https://cdn.jsdelivr.net/gh/beak2825/special-bassoon@main/night-city-racing/Build/NightCityRacing.loader.js"></script>
        <script>
        // URLs for the two .data.unityweb files
        const urls = [
            "https://raw.githubusercontent.com/beak2825/special-bassoon/refs/heads/main/night-city-racing/Build/1_NightCityRacing.data.unityweb",
            "https://raw.githubusercontent.com/beak2825/special-bassoon/refs/heads/main/night-city-racing/Build/2_NightCityRacing.data.unityweb"
        ];

        // Function to create a binary data of the two files
        async function getCombinedBinary(urls) {
            const responses = await Promise.all(urls.map(url => fetch(url)));
            const arrays = await Promise.all(responses.map(res => res.arrayBuffer()));

            // Calculate total size
            const totalSize = arrays.reduce((sum, buf) => sum + buf.byteLength, 0);

            // Combine the arrays
            const combined = new Uint8Array(totalSize);
            let offset = 0;
            arrays.forEach(buffer => {
                combined.set(new Uint8Array(buffer), offset);
                offset += buffer.byteLength;
            });

            return combined;
        }

        // Main logic
        (async function() {
            const combinedBinary = await getCombinedBinary(urls);

            const canvas = document.querySelector("#unity-canvas");
            const config = {
                dataUrl: combinedBinary, // Use the pure binary data directly
                frameworkUrl: "https://cdn.jsdelivr.net/gh/beak2825/special-bassoon@main/night-city-racing/Build/NightCityRacing.framework.js.unityweb",
                codeUrl: "https://cdn.jsdelivr.net/gh/beak2825/special-bassoon@main/night-city-racing/Build/NightCityRacing.wasm.unityweb",
                streamingAssetsUrl: "StreamingAssets",
                companyName: "Rhm Interactive",
                productName: "Night City Racing",
                productVersion: "0.1",
                webglContextAttributes: {
                    preserveDrawingBuffer: true,
                    powerPreference: "high-performance",
                },
            };

            let scaleToFit;
            try {
                scaleToFit = !!JSON.parse("");
            } catch (e) {
                scaleToFit = true;
            }

            function progressHandler(progress) {
                const percent = progress * 100 + '%';
                canvas.style.background = `linear-gradient(to right, white, white ${percent}, transparent ${percent}, transparent) no-repeat center`;
                canvas.style.backgroundSize = '100% 1rem';
                canvas.style.width = '250px';
                canvas.style.position = 'fixed';
                canvas.style.left = '50%';
                canvas.style.transform = 'translate(-50%)';
            }

            function onResize() {
                const container = canvas.parentElement;
                let w, h;

                if (scaleToFit) {
                    w = window.innerWidth;
                    h = window.innerHeight;

                    const r = 450 / 800;

                    if (w * r > window.innerHeight) {
                        w = Math.min(w, Math.ceil(h / r));
                    }
                    h = Math.floor(w * r);
                } else {
                    w = 800;
                    h = 450;
                }

                container.style.width = canvas.style.width = w + "px";
                container.style.height = canvas.style.height = h + "px";
                container.style.top = Math.floor((window.innerHeight - h) / 2) + "px";
                container.style.left = Math.floor((window.innerWidth - w) / 2) + "px";
            }

            createUnityInstance(canvas, config, progressHandler).then(function(instance) {
                canvas = instance.Module.canvas;
                onResize();
            });
            window.addEventListener('resize', onResize);
            onResize();
        })();
        </script>
    </div>
</body>

</html>