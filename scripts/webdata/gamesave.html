<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Game Loader</title>
  <style>
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      font-family: "Segoe UI", Arial, sans-serif;
      color: #fff;
    }
    #container {
      text-align: center;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 20px;
    }
    button {
      padding: 14px 24px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      background: #2a9df4;
      color: white;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      transition: background 0.25s ease;
    }
    button:hover:enabled {
      background: #1b7fc9;
    }
    button:disabled {
      background: #555;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div id="container">
    <h1 id="title">Preparing game for offline use...</h1>
    <button id="downloadBtn">Download</button>
  </div>

<script>
const params = new URLSearchParams(window.location.search);
const gameParam = params.get("game");
if (!gameParam) throw new Error("Missing ?game= parameter");

const match = gameParam.match(/^([^/]+)\//);
const GAME_NAME = match ? match[1] : "unknown";
const GAME_URL = "https://raw.githubusercontent.com/beak2825/special-bassoon/refs/heads/main/" + gameParam;

const DB_NAME  = `${GAME_NAME}_storage`;
const DB_STORE = "files";
const DB_KEY   = `${GAME_NAME}_html`;
const DATE_KEY = `${GAME_NAME}_storagedate`;  // timestamp in localStorage
const EXPIRY_MS = 4 * 24 * 60 * 60 * 1000;   // 4 days in ms

/* IndexedDB helpers */
function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = e => {
      e.target.result.createObjectStore(DB_STORE);
    };
    req.onsuccess = e => resolve(e.target.result);
    req.onerror = e => reject(e.target.error);
  });
}

function putData(db, key, value) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(DB_STORE, "readwrite");
    tx.objectStore(DB_STORE).put(value, key);
    tx.oncomplete = () => resolve();
    tx.onerror = e => reject(e.target.error);
  });
}

function getData(db, key) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(DB_STORE, "readonly");
    const req = tx.objectStore(DB_STORE).get(key);
    req.onsuccess = () => resolve(req.result);
    req.onerror = e => reject(e.target.error);
  });
}

function loadGame(html) {
  document.open();
  document.write(html);
  document.close();
}

/* Check expiry */
function isExpired() {
  const savedDate = localStorage.getItem(DATE_KEY);
  if (!savedDate) return true;
  const elapsed = Date.now() - parseInt(savedDate, 10);
  return elapsed > EXPIRY_MS;
}

async function fetchAndSave(db) {
  const res = await fetch(GAME_URL);
  if (!res.ok) throw new Error("Failed to fetch game file");
  const html = await res.text();
  await putData(db, DB_KEY, html);
  localStorage.setItem(DATE_KEY, Date.now().toString()); // update timestamp
  return html;
}

/* Main flow */
(async () => {
  const db = await openDB();
  let html = await getData(db, DB_KEY);

  if (!html || isExpired()) {
    try {
      html = await fetchAndSave(db);
      loadGame(html);
    } catch (err) {
      alert("Download failed: " + err.message);
    }
  } else {
    loadGame(html);
  }
})();
</script>

</script>
</body>
</html>
